<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Utilisateurs | Patro Admin</title>
    <meta name="robots" content="noindex, nofollow">
    
    <!-- On remonte d'un dossier pour le CSS -->
    <link rel="stylesheet" href="../style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = { theme: { extend: { colors: { patro: { yellow: '#FFD700', green: '#009045', dark: '#1a1a1a', light: '#f8fafc' } }, fontFamily: { sans: ['Poppins', 'sans-serif'], display: ['Fredoka', 'sans-serif'] } } } }
        
        // URL de votre API PHP
        const API_URL = "https://pvdhloginapi.alwaysdata.net/login.php";
    </script>
</head>
<body class="font-sans text-slate-800 bg-gray-100 antialiased min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b h-16 flex items-center justify-between px-6 shadow-sm sticky top-0 z-20">
        <div class="flex items-center gap-3">
            <a href="index.html" class="hover:opacity-70 transition"><img src="https://static.wixstatic.com/shapes/99150c_262f50afd9f748c1b2820587168d19f3.svg" class="h-8"></a>
            <span class="font-bold text-lg text-patro-green hidden md:block">Administration</span>
            <span class="text-gray-300">/</span>
            <span class="font-semibold text-gray-600">Utilisateurs</span>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-sm text-gray-500 hidden md:inline">Connecté en tant que <strong id="user-display-name">...</strong></span>
            <button onclick="logout()" class="text-red-500 hover:bg-red-50 p-2 rounded-full transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>
    </header>

    <div class="flex flex-1 max-w-7xl w-full mx-auto p-6 gap-8">
        
        <!-- Sidebar -->
        <aside class="w-64 hidden md:block">
            <nav class="space-y-1">
                <a href="index.html" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-white hover:shadow-sm rounded-lg transition">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Tableau de bord
                </a>
                <a href="#" class="flex items-center gap-3 px-4 py-3 bg-white text-patro-green font-bold shadow-sm rounded-lg">
                    <i data-lucide="users" class="w-5 h-5"></i> Utilisateurs
                </a>
                <a href="../index.html" target="_blank" class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-600 transition mt-8">
                    <i data-lucide="external-link" class="w-5 h-5"></i> Voir le site
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1">
            
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Gestion de l'équipe</h1>
                <button onclick="openModal()" class="bg-patro-green hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold shadow-sm flex items-center gap-2 transition">
                    <i data-lucide="user-plus" class="w-4 h-4"></i> Ajouter un membre
                </button>
            </div>

            <!-- Liste des utilisateurs -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-semibold">
                        <tr>
                            <th class="px-6 py-4">Nom & Prénom</th>
                            <th class="px-6 py-4">Identifiant</th>
                            <th class="px-6 py-4">Rôle</th>
                            <th class="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-list" class="divide-y divide-gray-100">
                        <!-- Rempli par JS -->
                        <tr><td colspan="4" class="px-6 py-8 text-center text-gray-400">Chargement...</td></tr>
                    </tbody>
                </table>
            </div>

        </main>
    </div>

    <!-- MODALE AJOUT -->
    <div id="add-modal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800">Nouveau Membre</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6">
                <form id="create-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Prénom</label>
                            <input type="text" id="new_prenom" required class="w-full p-2 border rounded focus:border-patro-green outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nom</label>
                            <input type="text" id="new_nom" required class="w-full p-2 border rounded focus:border-patro-green outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Identifiant (Email)</label>
                        <input type="text" id="new_username" required class="w-full p-2 border rounded focus:border-patro-green outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mot de passe</label>
                        <input type="password" id="new_password" required class="w-full p-2 border rounded focus:border-patro-green outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Rôle</label>
                        <select id="new_role" class="w-full p-2 border rounded focus:border-patro-green outline-none bg-white">
                            <option value="animateur">Animateur</option>
                            <option value="admin">Administrateur</option>
                        </select>
                    </div>
                    <div class="pt-2">
                        <button type="submit" class="w-full bg-patro-green text-white font-bold py-2.5 rounded-lg hover:bg-green-700 transition">Créer le compte</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // Vérification Auth
        try {
            const userJson = sessionStorage.getItem('patro_user');
            if (!userJson) {
                window.location.href = 'index.html'; // Retour login si pas connecté
            } else {
                const user = JSON.parse(userJson);
                if (user.role !== 'admin') {
                    alert("Accès réservé aux administrateurs.");
                    window.location.href = 'index.html';
                }
                document.getElementById('user-display-name').innerText = user.prenom;
                // Chargement liste
                loadUsers();
            }
        } catch (e) {
            console.error("Erreur d'authentification", e);
            window.location.href = 'index.html';
        }

        async function loadUsers() {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'list_users' })
                });
                const data = await res.json();
                
                const tbody = document.getElementById('users-list');
                tbody.innerHTML = '';

                if (data.success) {
                    // Récupérer l'utilisateur courant pour comparaison
                    const currentUser = JSON.parse(sessionStorage.getItem('patro_user'));
                    
                    data.users.forEach(u => {
                        const isMe = u.id == currentUser.id;
                        const row = `
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-6 py-4">
                                    <div class="font-bold text-gray-900">${u.prenom} ${u.nom}</div>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-500">${u.username}</td>
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 text-xs font-bold rounded-full ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}">
                                        ${u.role}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    ${!isMe ? `
                                    <button onclick="deleteUser(${u.id}, '${u.username}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition" title="Supprimer">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>` : '<span class="text-xs text-gray-400 italic">Vous</span>'}
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                    lucide.createIcons();
                }
            } catch (e) {
                alert("Erreur chargement liste.");
            }
        }

        // Création
        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Création..."; btn.disabled = true;

            const payload = {
                action: 'create_user',
                new_username: document.getElementById('new_username').value,
                new_password: document.getElementById('new_password').value,
                new_nom: document.getElementById('new_nom').value,
                new_prenom: document.getElementById('new_prenom').value,
                new_role: document.getElementById('new_role').value
            };

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if(data.success) {
                    closeModal();
                    e.target.reset();
                    loadUsers();
                    alert("Utilisateur ajouté !");
                } else {
                    alert("Erreur : " + data.message);
                }
            } catch(err) { alert("Erreur serveur."); }
            finally { btn.innerText = originalText; btn.disabled = false; }
        });

        // Suppression
        async function deleteUser(id, name) {
            if(!confirm("Voulez-vous vraiment supprimer l'utilisateur " + name + " ?")) return;
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'delete_user', id_to_delete: id })
                });
                const data = await res.json();
                if(data.success) {
                    loadUsers();
                } else {
                    alert("Erreur suppression.");
                }
            } catch(e) { alert("Erreur serveur."); }
        }

        // Modale
        function openModal() { document.getElementById('add-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('add-modal').classList.add('hidden'); }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
