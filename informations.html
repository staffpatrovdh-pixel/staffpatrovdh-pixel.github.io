<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communications | Patro du Val d'Haine</title>
    
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Mise à jour version 6 -->
    <script src="layout.js?v=6"></script>

    <script>
        tailwind.config = { theme: { extend: { colors: { patro: { yellow: '#FFD700', green: '#009045', dark: '#1a1a1a', light: '#f8fafc' } }, fontFamily: { sans: ['Poppins', 'sans-serif'], display: ['Fredoka', 'sans-serif'] } } } }
    </script>
</head>
<body class="font-sans text-slate-800 bg-patro-light antialiased">

    <div id="custom-cursor"></div>
    <div id="loader"><div class="spinner mb-4"></div><p class="text-patro-green font-bold font-display animate-pulse">Chargement...</p></div>
    <div id="navbar-placeholder"></div>

    <div class="pt-32 pb-12 bg-patro-green text-center relative overflow-hidden">
        <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'1\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
        <h1 class="text-4xl font-display font-bold text-white relative z-10">Communications & Agenda</h1>
        <p class="text-green-100 mt-2 relative z-10">Toutes les dernières nouvelles du Patro en direct.</p>
    </div>

    <section class="py-16 px-4">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-12">
            
            <!-- COLONNE GAUCHE : CALENDRIER -->
            <div class="lg:col-span-1 space-y-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-3 bg-patro-yellow rounded-xl shadow-sm text-patro-dark">
                        <i data-lucide="calendar-days" class="w-6 h-6"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 font-display">Prochaines dates</h2>
                </div>

                <div id="calendar-container" class="space-y-4">
                    <div class="animate-pulse flex space-x-4 bg-white p-4 rounded-xl">
                        <div class="rounded-full bg-gray-200 h-10 w-10"></div>
                        <div class="flex-1 space-y-2 py-1">
                            <div class="h-2 bg-gray-200 rounded"></div>
                            <div class="h-2 bg-gray-200 rounded w-3/4"></div>
                        </div>
                    </div>
                </div>
                 <!-- Petit lien vers l'agenda complet -->
                 <div class="text-center mt-2">
                    <a href="https://calendar.google.com/calendar/embed?src=staff.patrovdh%40gmail.com&ctz=Europe%2FBrussels" target="_blank" class="text-xs text-gray-500 hover:text-patro-green underline">
                        Ouvrir dans Google Agenda
                    </a>
                </div>
            </div>

            <!-- COLONNE DROITE : VALVES INFO -->
            <div class="lg:col-span-2">
                <div class="flex items-center gap-3 mb-6">
                    <div class="p-3 bg-patro-green rounded-xl shadow-sm text-white">
                        <i data-lucide="bell" class="w-6 h-6"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 font-display">Communications</h2>
                </div>

                <div class="bg-white p-8 rounded-3xl shadow-lg border border-gray-100 relative overflow-hidden min-h-[400px]">
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i data-lucide="pin" class="w-12 h-12 text-patro-dark transform rotate-45"></i>
                    </div>

                    <div id="valves-content" class="prose prose-green max-w-none">
                        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                            <div class="spinner mb-4 border-gray-300 border-t-patro-green"></div>
                            <p>Récupération des dernières infos...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <div id="footer-placeholder"></div>

    <script>
        // CONFIGURATION
        const repoOwner = 'staffpatrovdh-pixel'; 
        const repoName = 'staffpatrovdh-pixel.github.io';
        const branch = 'main'; 
        
        // URL Valves (Markdown) - Inchangé
        const valvesUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branch}/donnees-site/valves.md?t=${Date.now()}`;

        // CONFIGURATION GOOGLE AGENDA
        const CALENDAR_ID = 'staff.patrovdh@gmail.com';
        // J'ai repris la clé que tu as mise dans index.html
        const API_KEY = 'AIzaSyDA0jGeq43fHI30WeY126gBf82gVYSfV48'; 

        // Mapping Mois
        const monthMap = {
            0: 'Janv', 1: 'Fév', 2: 'Mars', 3: 'Avr', 4: 'Mai', 5: 'Juin',
            6: 'Juil', 7: 'Août', 8: 'Sept', 9: 'Oct', 10: 'Nov', 11: 'Déc'
        };

        // Fonction formatage date (même que sur l'accueil)
        function formatPatroEventDate(start, end) {
            const startDate = new Date(start.dateTime || start.date);
            const endDate = new Date(end.dateTime || end.date);
            const isAllDay = !start.dateTime;

            if (isAllDay) endDate.setDate(endDate.getDate() - 1);

            const isSameDay = startDate.getDate() === endDate.getDate() && 
                              startDate.getMonth() === endDate.getMonth() && 
                              startDate.getFullYear() === endDate.getFullYear();

            const optionsDay = { day: 'numeric', month: 'long' };
            const optionsTime = { hour: '2-digit', minute: '2-digit' };

            if (isAllDay && isSameDay) return `Le ${startDate.toLocaleDateString('fr-FR', optionsDay)}`;
            if (isAllDay && !isSameDay) return `Du ${startDate.toLocaleDateString('fr-FR', optionsDay)} au ${endDate.toLocaleDateString('fr-FR', optionsDay)}`;
            if (!isAllDay && isSameDay) return `Le ${startDate.toLocaleDateString('fr-FR', optionsDay)} de ${startDate.toLocaleTimeString('fr-FR', optionsTime)} à ${endDate.toLocaleTimeString('fr-FR', optionsTime)}`;
            return `Du ${startDate.toLocaleDateString('fr-FR', optionsDay)} (${startDate.toLocaleTimeString('fr-FR', optionsTime)}) au ${endDate.toLocaleDateString('fr-FR', optionsDay)} (${endDate.toLocaleTimeString('fr-FR', optionsTime)})`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadGoogleCalendar();
            loadValves();
        });

        async function loadGoogleCalendar() {
            const container = document.getElementById('calendar-container');

            try {
                const timeMin = new Date().toISOString();
                const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events?key=${API_KEY}&singleEvents=true&orderBy=startTime&timeMin=${timeMin}&maxResults=15`; // Max 15 events ici

                const response = await fetch(url);
                if (!response.ok) throw new Error("Erreur API Google");

                const data = await response.json();
                const events = data.items;

                container.innerHTML = '';

                if (!events || events.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 italic p-4 text-center">Aucune date prévue pour le moment.</p>';
                    return;
                }

                events.forEach(event => {
                    const start = event.start;
                    const end = event.end;
                    const title = event.summary;
                    const place = event.location || '';
                    const linkUrl = event.description && event.description.includes('http') ? event.description.match(/https?:\/\/[^\s]+/)[0] : '';

                    // Date pour l'icône
                    const dateObj = new Date(start.dateTime || start.date);
                    const day = dateObj.getDate();
                    const monthName = monthMap[dateObj.getMonth()];
                    
                    // Texte descriptif complet
                    const dateString = formatPatroEventDate(start, end);

                    const innerContent = `
                            <div class="flex-shrink-0 bg-gray-50 rounded-lg p-2 text-center min-w-[60px] self-center">
                                <span class="block text-xs text-gray-500 font-bold uppercase">${monthName}</span>
                                <span class="block text-xl font-bold text-patro-dark">${day}</span>
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-bold text-gray-800 text-lg group-hover:text-patro-green transition">${title}</h3>
                                <p class="text-sm text-patro-green font-medium mb-1"><i data-lucide="clock" class="w-3 h-3 inline"></i> ${dateString}</p>
                                ${place ? `<p class="text-sm text-gray-500 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${place}</p>` : ''}
                            </div>
                    `;
                    
                    let html = '';
                    // Classe de base (avec border jaune sur le côté)
                    const baseClass = "bg-white p-4 rounded-xl shadow-sm border-l-4 border-patro-yellow hover:shadow-md transition flex items-start gap-4 group";

                    if (linkUrl) {
                        html = `<a href="${linkUrl}" target="_blank" class="${baseClass} cursor-pointer block text-left decoration-0">${innerContent}</a>`;
                    } else {
                        html = `<div class="${baseClass}">${innerContent}</div>`;
                    }

                    container.innerHTML += html;
                });
                
                if(typeof lucide !== 'undefined') lucide.createIcons();

            } catch (error) {
                console.error(error);
                container.innerHTML = `
                    <div class="bg-red-50 text-red-500 p-4 rounded-lg text-sm text-center">
                        Impossible de charger le calendrier.<br>
                        <a href="https://calendar.google.com/calendar/embed?src=${CALENDAR_ID}" target="_blank" class="underline mt-2 inline-block">Voir sur Google Agenda</a>
                    </div>`;
            }
        }

        async function loadValves() {
            try {
                const response = await fetch(valvesUrl);
                if (!response.ok) throw new Error("Fichier valves introuvable");
                const markdownText = await response.text();
                const container = document.getElementById('valves-content');
                marked.setOptions({ breaks: true });
                container.innerHTML = marked.parse(markdownText);
            } catch (error) {
                console.error(error);
                document.getElementById('valves-content').innerHTML = 
                    '<div class="bg-red-50 text-red-500 p-4 rounded-lg text-center">Impossible de charger les informations.</div>';
            }
        }
    </script>

    <style>
        .prose h1 { font-family: 'Fredoka', sans-serif; color: var(--patro-green); font-size: 1.8em; margin-bottom: 0.5em; margin-top: 1em; }
        .prose h1:first-child { margin-top: 0; }
        .prose h2 { font-family: 'Fredoka', sans-serif; color: var(--patro-dark); font-size: 1.4em; margin-top: 1em; margin-bottom: 0.5em; }
        .prose p { margin-bottom: 1em; color: #4b5563; line-height: 1.6; }
        .prose strong { color: var(--patro-dark); font-weight: 700; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; color: #4b5563; }
        .prose li { margin-bottom: 0.3em; }
        .prose blockquote { border-left: 4px solid var(--patro-yellow); padding-left: 1em; font-style: italic; background: #fffbeb; padding: 1em; border-radius: 0 8px 8px 0; }
        .prose a { color: var(--patro-green); text-decoration: underline; font-weight: bold; }
    </style>
</body>
</html>
