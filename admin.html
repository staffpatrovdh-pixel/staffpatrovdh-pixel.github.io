<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Patro du Val d'Haine</title>
    <meta name="robots" content="noindex, nofollow">
    
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        const REPO_OWNER = "staffpatrovdh-pixel";
        const REPO_NAME = "staffpatrovdh-pixel.github.io";
        const BRANCH = "main";
        
        tailwind.config = { theme: { extend: { colors: { patro: { yellow: '#FFD700', green: '#009045', dark: '#1a1a1a', light: '#f8fafc' } }, fontFamily: { sans: ['Poppins', 'sans-serif'], display: ['Fredoka', 'sans-serif'] } } } }
    </script>

    <style>
        body { background: #f3f4f6; font-family: 'Poppins', sans-serif; }
        .sidebar-btn { display: flex; align-items: center; gap: 10px; padding: 12px 16px; width: 100%; text-align: left; border-radius: 8px; transition: 0.2s; color: #4b5563; font-weight: 500; }
        .sidebar-btn:hover { background: #e5e7eb; color: #1f2937; }
        .sidebar-btn.active { background: #dcfce7; color: #166534; font-weight: 600; }
        
        .file-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; transition: 0.2s; }
        .file-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-color: #009045; }
        
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100; display: none; justify-content: center; align-items: center; flex-direction: column; }
        
        /* Staff Card Admin */
        .staff-row { display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; }
        .staff-img-preview { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

    <div id="loader"><div class="animate-spin rounded-full h-10 w-10 border-b-4 border-patro-green mb-2"></div><p class="text-sm font-bold text-gray-500" id="loader-text">Chargement...</p></div>
    <div id="custom-cursor"></div>

    <!-- LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-xl border-t-4 border-patro-green text-center">
            <img src="https://static.wixstatic.com/shapes/99150c_262f50afd9f748c1b2820587168d19f3.svg" class="h-20 mx-auto mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Accès Staff</h1>
            <form onsubmit="login(event)" class="space-y-4 mt-6">
                <input type="password" id="token-input" placeholder="Clé d'accès (Token)" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-patro-green" required>
                <button class="w-full bg-patro-green text-white font-bold py-3 rounded-lg hover:bg-green-700 transition">Connexion</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden flex flex-col h-screen">
        <header class="bg-white h-16 border-b flex items-center justify-between px-6 shadow-sm z-10 flex-shrink-0">
            <div class="flex items-center gap-3">
                <img src="https://static.wixstatic.com/shapes/99150c_262f50afd9f748c1b2820587168d19f3.svg" class="h-8">
                <span class="font-bold text-lg text-patro-green">Administration</span>
            </div>
            <button onclick="logout()" class="text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-md transition flex gap-2 font-medium"><i data-lucide="log-out" class="w-5 h-5"></i> Déconnexion</button>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <aside class="w-64 bg-white border-r flex flex-col overflow-y-auto p-4 space-y-1">
                <p class="px-3 text-xs font-bold text-gray-400 uppercase mb-2">Gestion</p>
                <button onclick="loadSection('staff')" class="sidebar-btn" id="btn-staff"><i data-lucide="users" class="w-5 h-5 text-blue-500"></i> Gestion Équipe</button>
                <button onclick="loadSection('texts')" class="sidebar-btn active" id="btn-texts"><i data-lucide="file-edit" class="w-5 h-5 text-gray-500"></i> Agenda & Valves</button>
                
                <p class="px-3 text-xs font-bold text-gray-400 uppercase mb-2 mt-6">Fichiers</p>
                <button onclick="loadFileManager('documents', 'Documents')" class="sidebar-btn" id="btn-docs"><i data-lucide="file-text" class="w-5 h-5 text-yellow-500"></i> Documents PDF</button>
                <button onclick="loadFileManager('donnees-site/photos-site-accueil', 'Accueil')" class="sidebar-btn" id="btn-home"><i data-lucide="image" class="w-5 h-5 text-purple-500"></i> Photos Accueil</button>
            </aside>

            <main class="flex-1 overflow-y-auto p-8 bg-gray-50">
                
                <!-- VUE : GESTION STAFF (NOUVEAU) -->
                <div id="view-staff" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">L'équipe d'animation</h2>
                        <button onclick="addNewMember()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 flex gap-2"><i data-lucide="plus" class="w-5 h-5"></i> Ajouter un membre</button>
                    </div>

                    <div id="staff-list" class="space-y-4">
                        <!-- Liste générée par JS -->
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t">
                        <button onclick="saveStaffJSON()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 shadow-lg flex gap-2"><i data-lucide="save" class="w-5 h-5"></i> Enregistrer les modifications</button>
                    </div>
                </div>

                <!-- VUE : TEXTES -->
                <div id="view-texts" class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Textes du site</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <div class="flex justify-between mb-4"><h3 class="font-bold flex gap-2"><i data-lucide="calendar" class="w-5 h-5 text-patro-yellow"></i> Calendrier</h3><span class="text-xs text-gray-400">calendrier.txt</span></div>
                            <textarea id="cal-content" class="w-full h-64 p-3 border rounded-lg font-mono text-sm resize-none outline-none focus:border-patro-green"></textarea>
                            <button onclick="saveFile('donnees-site/calendrier.txt', 'cal-content')" class="mt-4 w-full bg-patro-yellow text-patro-dark font-bold py-2 rounded hover:bg-yellow-400">Sauvegarder</button>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <div class="flex justify-between mb-4"><h3 class="font-bold flex gap-2"><i data-lucide="bell" class="w-5 h-5 text-patro-green"></i> Valves</h3><span class="text-xs text-gray-400">valves.md</span></div>
                            <textarea id="val-content" class="w-full h-64 p-3 border rounded-lg font-mono text-sm resize-none outline-none focus:border-patro-green"></textarea>
                            <button onclick="saveFile('donnees-site/valves.md', 'val-content')" class="mt-4 w-full bg-patro-green text-white font-bold py-2 rounded hover:bg-green-700">Sauvegarder</button>
                        </div>
                    </div>
                </div>

                <!-- VUE : FICHIERS -->
                <div id="view-files" class="hidden h-full flex flex-col">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <div><h2 class="text-2xl font-bold text-gray-800" id="fm-title">Dossier</h2><p class="text-gray-500 text-sm font-mono mt-1 bg-gray-200 px-2 rounded inline-block" id="fm-path">...</p></div>
                        <div class="flex gap-3">
                            <button onclick="refreshFiles()" class="p-2 bg-white border rounded-lg hover:bg-gray-100"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
                            <label class="cursor-pointer bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition flex items-center gap-2 shadow-sm"><i data-lucide="upload" class="w-5 h-5"></i> Ajouter<input type="file" id="file-upload" class="hidden" onchange="uploadFile(this)"></label>
                        </div>
                    </div>
                    <div id="file-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 pb-10"></div>
                </div>

            </main>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        let TOKEN = localStorage.getItem('patro_token');
        let currentPath = ''; let fileShas = {};
        let staffData = []; // Stocke les données du staff localement

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (TOKEN) showDashboard();
            
            // Curseur
            const c = document.getElementById('custom-cursor');
            if(window.matchMedia("(pointer:fine)").matches){
                document.addEventListener('mousemove', e => { c.style.left = e.clientX + 'px'; c.style.top = e.clientY + 'px'; });
            }
        });

        function login(e) {
            e.preventDefault();
            const t = document.getElementById('token-input').value.trim();
            if(t.startsWith('ghp_') || t.startsWith('github_pat_')) {
                localStorage.setItem('patro_token', t); TOKEN = t; showDashboard();
            } else { alert("Token invalide"); }
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadSection('texts');
            loadText('donnees-site/calendrier.txt', 'cal-content');
            loadText('donnees-site/valves.md', 'val-content');
        }

        function logout() { localStorage.removeItem('patro_token'); location.reload(); }

        function loadSection(id) {
            document.getElementById('view-texts').classList.add('hidden');
            document.getElementById('view-files').classList.add('hidden');
            document.getElementById('view-staff').classList.add('hidden');
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('view-'+id).classList.remove('hidden');
            document.getElementById('btn-'+id).classList.add('active');

            if(id === 'staff') loadStaffEditor();
        }

        function loadFileManager(path, title) {
            loadSection('files');
            document.getElementById('fm-title').innerText = title;
            document.getElementById('fm-path').innerText = path;
            currentPath = path;
            refreshFiles();
        }

        // --- GESTION STAFF (JSON EDITOR) ---
        async function loadStaffEditor() {
            showLoader('Chargement du staff...');
            try {
                const data = await ghFetch('donnees-site/staff.json');
                fileShas['donnees-site/staff.json'] = data.sha;
                const content = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
                staffData = JSON.parse(content);
                renderStaffList();
            } catch(e) { console.error(e); } finally { hideLoader(); }
        }

        function renderStaffList() {
            const list = document.getElementById('staff-list');
            list.innerHTML = '';
            staffData.forEach((member, index) => {
                const div = document.createElement('div');
                div.className = 'staff-row flex items-start gap-4 bg-white p-4 rounded-lg border shadow-sm';
                div.innerHTML = `
                    <div class="flex-shrink-0 text-center space-y-2">
                        <img src="donnees-site/photos-staff/${member.photo}" class="w-16 h-16 rounded-full object-cover bg-gray-100 border mx-auto" onerror="this.src='https://placehold.co/100'">
                        <button onclick="changePhoto(${index})" class="text-xs text-blue-500 hover:underline block">Changer photo</button>
                        <input type="file" id="photo-input-${index}" class="hidden" onchange="uploadStaffPhoto(${index}, this)">
                    </div>
                    <div class="grid grid-cols-2 gap-3 flex-1">
                        <div><label class="text-xs font-bold text-gray-400">Totem</label><input type="text" value="${member.totem || ''}" onchange="updateStaff(${index}, 'totem', this.value)" class="w-full p-1 border rounded text-sm font-bold"></div>
                        <div><label class="text-xs font-bold text-gray-400">Nom Réel</label><input type="text" value="${member.nom || ''}" onchange="updateStaff(${index}, 'nom', this.value)" class="w-full p-1 border rounded text-sm"></div>
                        <div><label class="text-xs font-bold text-gray-400">Rôle (Tag)</label><input type="text" value="${member.role || ''}" onchange="updateStaff(${index}, 'role', this.value)" class="w-full p-1 border rounded text-sm"></div>
                        <div><label class="text-xs font-bold text-gray-400">Fonction</label><input type="text" value="${member.fonction || ''}" onchange="updateStaff(${index}, 'fonction', this.value)" class="w-full p-1 border rounded text-sm"></div>
                        <div><label class="text-xs font-bold text-gray-400">Téléphone</label><input type="text" value="${member.tel || ''}" onchange="updateStaff(${index}, 'tel', this.value)" class="w-full p-1 border rounded text-sm"></div>
                        <div><label class="text-xs font-bold text-gray-400">Email</label><input type="text" value="${member.mail || ''}" onchange="updateStaff(${index}, 'mail', this.value)" class="w-full p-1 border rounded text-sm"></div>
                    </div>
                    <button onclick="removeMember(${index})" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2"></i></button>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        function updateStaff(index, key, value) { staffData[index][key] = value; }

        function addNewMember() {
            staffData.push({ totem: "Nouveau", nom: "", role: "", fonction: "Animateur", photo: "default.png" });
            renderStaffList();
        }

        function removeMember(index) {
            if(confirm("Supprimer ce membre ?")) {
                staffData.splice(index, 1);
                renderStaffList();
            }
        }

        function changePhoto(index) { document.getElementById(`photo-input-${index}`).click(); }

        async function uploadStaffPhoto(index, input) {
            if(input.files[0]) {
                const file = input.files[0];
                showLoader("Upload photo...");
                // 1. Upload image to GitHub
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const content = e.target.result.split(',')[1];
                    const path = `donnees-site/photos-staff/${file.name}`;
                    
                    // Check if exists (get SHA)
                    let sha = null;
                    try { const check = await ghFetch(path); sha = check.sha; } catch(e){}

                    try {
                        await apiCall(path, 'PUT', { message: `Upload photo ${file.name}`, content: content, branch: BRANCH, sha: sha });
                        // 2. Update JSON data reference
                        staffData[index].photo = file.name;
                        renderStaffList();
                        alert("Photo mise à jour ! Pensez à enregistrer le staff.");
                    } catch(err) { alert("Erreur upload photo"); } finally { hideLoader(); }
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveStaffJSON() {
            showLoader("Sauvegarde Staff...");
            const jsonString = JSON.stringify(staffData, null, 2);
            const encoded = btoa(unescape(encodeURIComponent(jsonString)));
            
            try {
                await apiCall('donnees-site/staff.json', 'PUT', {
                    message: "Update Staff List",
                    content: encoded,
                    sha: fileShas['donnees-site/staff.json'],
                    branch: BRANCH
                });
                // Refresh SHA
                const data = await ghFetch('donnees-site/staff.json');
                fileShas['donnees-site/staff.json'] = data.sha;
                alert("Équipe mise à jour avec succès !");
            } catch(e) { alert("Erreur sauvegarde"); } finally { hideLoader(); }
        }

        // --- API UTILS ---
        async function ghFetch(path) {
            const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}?ref=${BRANCH}&t=${Date.now()}`, { headers: { 'Authorization': `token ${TOKEN}`, 'Accept': 'application/vnd.github.v3+json' } });
            if(!res.ok) throw new Error("Erreur GitHub");
            return await res.json();
        }

        async function apiCall(path, method, body) {
            const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, {
                method: method,
                headers: { 'Authorization': `token ${TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if(!res.ok) throw new Error("Erreur API");
            return await res.json();
        }

        // --- FONCTIONS STANDARDS (Textes & Fichiers) ---
        async function loadText(path, elId) {
            try {
                const data = await ghFetch(path);
                fileShas[path] = data.sha;
                document.getElementById(elId).value = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
            } catch(e) {}
        }

        async function saveFile(path, elId) {
            showLoader("Sauvegarde...");
            const content = document.getElementById(elId).value;
            const encoded = btoa(unescape(encodeURIComponent(content)));
            try {
                await apiCall(path, 'PUT', { message: `Update ${path}`, content: encoded, sha: fileShas[path], branch: BRANCH });
                // Refresh SHA
                const data = await ghFetch(path);
                fileShas[path] = data.sha;
                alert("Sauvegardé !");
            } catch(e) { alert("Erreur"); } finally { hideLoader(); }
        }

        async function refreshFiles() {
            const grid = document.getElementById('file-grid');
            grid.innerHTML = '<p class="col-span-full text-center text-gray-400">Chargement...</p>';
            try {
                const files = await ghFetch(currentPath);
                grid.innerHTML = '';
                files.forEach(f => {
                    if(f.type === 'file') {
                        fileShas[f.path] = f.sha;
                        const isImg = f.name.match(/\.(jpg|jpeg|png|gif)$/i);
                        const preview = isImg ? `<img src="${f.download_url}" class="w-full h-32 object-cover bg-gray-100">` : `<div class="w-full h-32 bg-gray-50 flex items-center justify-center"><i data-lucide="file-text" class="w-10 h-10 text-gray-400"></i></div>`;
                        
                        grid.innerHTML += `
                        <div class="file-card flex flex-col">
                            ${preview}
                            <div class="p-3">
                                <p class="text-xs font-bold truncate mb-2" title="${f.name}">${f.name}</p>
                                <div class="flex justify-between">
                                    <a href="${f.download_url}" target="_blank" class="text-blue-500"><i data-lucide="eye" class="w-4 h-4"></i></a>
                                    <button onclick="deleteFile('${f.name}', '${f.sha}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>`;
                    }
                });
                lucide.createIcons();
            } catch(e) { grid.innerHTML = '<p class="col-span-full text-center text-gray-400">Dossier vide.</p>'; }
        }

        async function uploadFile(input) {
            if(input.files[0]) {
                showLoader("Envoi...");
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const content = e.target.result.split(',')[1];
                    const path = `${currentPath}/${file.name}`;
                    let sha = null;
                    if(fileShas[path]) sha = fileShas[path]; // Overwrite
                    try {
                        await apiCall(path, 'PUT', { message: `Add ${file.name}`, content: content, branch: BRANCH, sha: sha });
                        refreshFiles();
                    } catch(e) { alert("Erreur upload"); } finally { hideLoader(); }
                };
                reader.readAsDataURL(file);
            }
            input.value = '';
        }

        async function deleteFile(name, sha) {
            if(confirm("Supprimer ?")) {
                showLoader("Suppression...");
                try {
                    await apiCall(`${currentPath}/${name}`, 'DELETE', { message: `Del ${name}`, sha: sha, branch: BRANCH });
                    refreshFiles();
                } catch(e) { alert("Erreur"); } finally { hideLoader(); }
            }
        }

        function showLoader(t) { document.getElementById('loader-text').innerText = t; document.getElementById('loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loader').style.display = 'none'; }
    </script>
</body>
</html>
